{
  "name": "V3 Three-Engine Strategy",
  "type": "feature",
  "created": "2026-01-14T12:00:00Z",
  "source": "tasks/spec-v3-strategy.md",
  "config": {
    "backend": "rust",
    "frontend": "none",
    "infra": "none"
  },
  "tasks": [
    {
      "id": "p1-1",
      "title": "Phase 1: Add Signal enum and detection",
      "description": "Implement directional signal based on BTC price vs strike. Create Signal enum (StrongUp, LeanUp, Neutral, LeanDown, StrongDown) with up_ratio/down_ratio methods. Implement get_signal() and get_thresholds() functions with time-based threshold tightening.",
      "status": "completed",
      "depends": [],
      "files": [
        "crates/poly-bot/src/strategy/signal.rs",
        "crates/poly-bot/src/strategy/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Unit tests pass for all signal thresholds",
        "All 5 time brackets tested"
      ]
    },
    {
      "id": "p1-2",
      "title": "Phase 1: Add Confidence types for sizing",
      "description": "Create ConfidenceFactors struct (distance, minutes_remaining, signal, book_imbalance, favorable_depth) and Confidence struct (time, distance, signal, book). Implement total_multiplier() using geometric mean with 0.5x-3.0x caps.",
      "status": "completed",
      "depends": ["p1-1"],
      "files": [
        "crates/poly-bot/src/strategy/confidence.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Confidence calculation matches spec examples",
        "Unit tests for multiplier caps"
      ]
    },
    {
      "id": "p1-3",
      "title": "Phase 1: Add Position and trade decision types",
      "description": "Add EngineType enum (Arbitrage, Directional, MakerRebates), Position struct with cost/share tracking, and calculate_pnl(). Extend TradeDecision with engine variants. Use Decimal for all financial math.",
      "status": "completed",
      "depends": [],
      "files": [
        "crates/poly-bot/src/types.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "cargo check passes",
        "Types integrate with existing Inventory"
      ]
    },
    {
      "id": "p2-1",
      "title": "Phase 2: Add fee rate client",
      "description": "Create api/ module with fee rate fetching from GET /fee-rate?token_id=X. Add FeeRateResponse struct, implement fetch_fee_rate() with in-memory caching per market session. Handle API errors gracefully.",
      "status": "completed",
      "depends": [],
      "files": [
        "crates/poly-bot/src/api/mod.rs",
        "crates/poly-bot/src/api/fees.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Can fetch fee rate for a token",
        "Cache prevents redundant API calls"
      ]
    },
    {
      "id": "p2-2",
      "title": "Phase 2: Add rewards client",
      "description": "Implement rewards API client with CurrentRewardResponse, RewardsConfig, UserEarningResponse types. Add fetch_current_rewards(), fetch_reward_percentages(), fetch_user_earnings() methods. Support periodic earnings tracking.",
      "status": "completed",
      "depends": ["p2-1"],
      "files": [
        "crates/poly-bot/src/api/rewards.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Can fetch current rewards config",
        "Can fetch user earnings for a date"
      ]
    },
    {
      "id": "p2-3",
      "title": "Phase 2: Create MarketSession with cached API data",
      "description": "Add MarketSession struct containing market_id, tokens, strike, fee_rate_bps, reward_config. Implement MarketSession::new() that fetches and caches API data. Integrate with TrackedMarket or StrategyLoop.",
      "status": "completed",
      "depends": ["p2-1", "p2-2"],
      "files": [
        "crates/poly-bot/src/types.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "MarketSession initializes with API data",
        "Fee rate cached per session"
      ]
    },
    {
      "id": "p3-1",
      "title": "Phase 3: Add TradingConfig with balance scaling",
      "description": "Create TradingConfig with available_balance, max_market_allocation (0.20), expected_trades_per_market (200), min_order_size ($1), max_confidence_multiplier (3.0), min_hedge_ratio (0.20). Implement market_budget() and base_order_size() methods.",
      "status": "completed",
      "depends": [],
      "files": [
        "crates/poly-bot/src/config.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "market_budget = balance * 0.20",
        "base_order_size = budget / 200",
        "Unit tests for $500-$25000 scaling"
      ]
    },
    {
      "id": "p3-2",
      "title": "Phase 3: Implement ConfidenceSizer",
      "description": "Create ConfidenceSizer with TradingConfig, spent, trades tracking. Implement get_order_size(factors) returning OrderSizeResult. Add confidence calculators: time_confidence(), distance_confidence(), signal_confidence(), book_confidence().",
      "status": "completed",
      "depends": ["p1-1", "p1-2", "p3-1"],
      "files": [
        "crates/poly-bot/src/strategy/confidence_sizing.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Sizing matches spec examples",
        "BudgetExhausted returned when spent >= budget"
      ]
    },
    {
      "id": "p3-3",
      "title": "Phase 3: Add configurable sizing mode",
      "description": "Add SizingMode enum (Limits, Confidence, Hybrid). Create SizingStrategy trait. Implement for existing PositionSizer and new ConfidenceSizer. Create HybridSizer that applies confidence then caps with limits. Add factory function.",
      "status": "completed",
      "depends": ["p3-2"],
      "files": [
        "crates/poly-bot/src/config.rs",
        "crates/poly-bot/src/strategy/sizing.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Can switch modes via TOML config",
        "Hybrid mode applies both sizing strategies"
      ]
    },
    {
      "id": "p4-1",
      "title": "Phase 4: Implement PnlRiskManager",
      "description": "Create PnlRiskManager with daily_pnl, consecutive_losses, trading_enabled tracking. Implement check_trade() returning TradeDecision (Approve/Reject/ReduceSize/RebalanceRequired). Add daily loss limit (10%), consecutive loss stop (3), hedge ratio check (20%).",
      "status": "completed",
      "depends": ["p1-3"],
      "files": [
        "crates/poly-bot/src/risk/pnl.rs",
        "crates/poly-bot/src/risk/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Rejects after 10% daily loss",
        "Disables after 3 consecutive losses",
        "Requires rebalance below 20% hedge ratio"
      ]
    },
    {
      "id": "p4-2",
      "title": "Phase 4: Add configurable risk mode",
      "description": "Add RiskMode enum (CircuitBreaker, DailyPnl, Both). Create RiskChecker trait. Implement CompositeRiskChecker that runs both when mode is Both. Integrate with StrategyLoop pre-trade checks.",
      "status": "completed",
      "depends": ["p4-1"],
      "files": [
        "crates/poly-bot/src/config.rs",
        "crates/poly-bot/src/risk/mod.rs",
        "crates/poly-bot/src/risk/mode.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Can select risk mode via config",
        "Both mode runs CB + PnlRiskManager"
      ]
    },
    {
      "id": "p5-1",
      "title": "Phase 5: Implement DirectionalDetector",
      "description": "Create DirectionalDetector using Signal system. Create DirectionalOpportunity struct (signal, up_ratio, down_ratio, confidence). Implement detect() returning opportunity with correct allocation ratios. Add skip reasons.",
      "status": "completed",
      "depends": ["p1-1", "p1-2"],
      "files": [
        "crates/poly-bot/src/strategy/directional.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "StrongUp returns 78% UP / 22% DOWN",
        "Neutral signal skips trading",
        "Unit tests for each signal level"
      ]
    },
    {
      "id": "p5-2",
      "title": "Phase 5: Implement directional execution",
      "description": "Add execute_directional() to StrategyLoop. Calculate UP/DOWN sizes from signal ratios. Calculate maker prices inside spread. Place orders with post_only: true. Update position tracking and record with sizer.",
      "status": "completed",
      "depends": ["p5-1", "p3-2"],
      "files": [
        "crates/poly-bot/src/strategy/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Places both UP and DOWN orders",
        "Position updated correctly",
        "Integration test passes"
      ]
    },
    {
      "id": "p6-1",
      "title": "Phase 6: Implement MakerDetector",
      "description": "Create MakerDetector for passive rebate strategy. Create MakerOpportunity struct (token_id, side, price, size, expected_rebate). Implement spread analysis for optimal maker price. Consider rewards_min_size and rewards_max_spread from API.",
      "status": "completed",
      "depends": ["p2-2"],
      "files": [
        "crates/poly-bot/src/strategy/maker.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Detects maker opportunities",
        "Respects min_size from reward config"
      ]
    },
    {
      "id": "p6-2",
      "title": "Phase 6: Implement maker order management",
      "description": "Add execute_maker() method. Track active maker orders per market. Implement order refresh logic (cancel stale, place new). Handle partial fills properly.",
      "status": "completed",
      "depends": ["p6-1"],
      "files": [
        "crates/poly-bot/src/strategy/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Maintains maker orders",
        "Cancels and refreshes stale orders",
        "Integration test passes"
      ]
    },
    {
      "id": "p7-1",
      "title": "Phase 7: Add engine configuration",
      "description": "Create EnginesConfig with ArbitrageEngineConfig, DirectionalEngineConfig, MakerEngineConfig. Each has enabled flag and engine-specific params. Add priority: Vec<EngineType> for conflict resolution.",
      "status": "completed",
      "depends": ["p1-3"],
      "files": [
        "crates/poly-bot/src/config.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "TOML deserialization works",
        "Default enables only arbitrage"
      ]
    },
    {
      "id": "p7-2",
      "title": "Phase 7: Implement DecisionAggregator",
      "description": "Create EngineDecision wrapper (engine_type, opportunity, sizing). Create DecisionAggregator. Implement aggregate() that picks best decision based on priority config. Handle conflicts (arb overrides directional).",
      "status": "completed",
      "depends": ["p7-1"],
      "files": [
        "crates/poly-bot/src/strategy/aggregator.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Priority ordering works",
        "Conflict resolution correct"
      ]
    },
    {
      "id": "p7-3",
      "title": "Phase 7: Integrate engines into StrategyLoop",
      "description": "Add engine instances (arb, directional, maker) and aggregator to StrategyLoop. Refactor check_opportunities() to run all enabled engines. Route execution to correct handler. Tag decisions with engine source for observability.",
      "status": "completed",
      "depends": ["p5-2", "p6-2", "p7-2"],
      "files": [
        "crates/poly-bot/src/strategy/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Multi-engine strategy runs",
        "Observability shows engine source",
        "Backward compatible with arb-only"
      ]
    },
    {
      "id": "p8-1",
      "title": "Phase 8: Implement TradeInterval",
      "description": "Create TradeInterval struct with min_interval (500ms) and last_trade tracking. Implement can_trade(), record_trade(), time_until_next(). Integrate into StrategyLoop main loop to avoid API rate limits.",
      "status": "completed",
      "depends": [],
      "files": [
        "crates/poly-bot/src/executor/interval.rs",
        "crates/poly-bot/src/executor/mod.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Enforces 500ms minimum between trades",
        "Unit tests pass"
      ]
    },
    {
      "id": "p8-2",
      "title": "Phase 8: Add maker price calculation",
      "description": "Implement get_maker_price(book) that calculates optimal price inside spread. Handle spread >3% (40% from bid), 1-3% (30% from bid), <1% (at bid). Return Decimal price.",
      "status": "pending",
      "depends": [],
      "files": [
        "crates/poly-bot/src/strategy/pricing.rs"
      ],
      "acceptance": [
        "cargo clippy -- -D warnings passes",
        "Places orders inside spread",
        "Unit tests for all spread sizes"
      ]
    },
    {
      "id": "p9-1",
      "title": "Phase 9: Unit tests for all new modules",
      "description": "Add comprehensive unit tests: Signal detection (all time brackets), Confidence calculation (spec examples), TradingConfig scaling, ConfidenceSizer (budget, multipliers), PnlRiskManager (all rules), DirectionalDetector, DecisionAggregator priority.",
      "status": "pending",
      "depends": ["p7-3"],
      "files": [
        "crates/poly-bot/src/strategy/signal.rs",
        "crates/poly-bot/src/strategy/confidence.rs",
        "crates/poly-bot/src/strategy/confidence_sizing.rs",
        "crates/poly-bot/src/risk/pnl.rs",
        "crates/poly-bot/src/strategy/directional.rs",
        "crates/poly-bot/src/strategy/aggregator.rs"
      ],
      "acceptance": [
        "cargo test passes",
        "All modules have inline tests"
      ]
    },
    {
      "id": "p9-2",
      "title": "Phase 9: Integration tests",
      "description": "Create integration tests: test_directional_strategy.rs, test_multi_engine.rs, test_confidence_sizing.rs, test_pnl_risk.rs. Verify strategy runs correctly in backtest mode.",
      "status": "pending",
      "depends": ["p9-1"],
      "files": [
        "crates/poly-bot/tests/test_directional_strategy.rs",
        "crates/poly-bot/tests/test_multi_engine.rs",
        "crates/poly-bot/tests/test_confidence_sizing.rs",
        "crates/poly-bot/tests/test_pnl_risk.rs"
      ],
      "acceptance": [
        "cargo test --test '*' passes",
        "Backtest mode works with new engines"
      ]
    },
    {
      "id": "p9-3",
      "title": "Phase 9: Backtest validation",
      "description": "Run backtest with directional engine enabled. Compare results to spec Section 8 expected economics. Tune thresholds if needed. Document findings and any parameter adjustments.",
      "status": "pending",
      "depends": ["p9-2"],
      "files": [
        "tasks/progress.txt"
      ],
      "acceptance": [
        "Backtest completes successfully",
        "P&L within expected range from spec",
        "Findings documented in progress.txt"
      ]
    }
  ]
}
