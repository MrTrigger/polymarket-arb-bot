# Progress Log

## Project Config
backend: rust
frontend: none
infra: kubernetes

## Project Overview
Polymarket 15-Minute Arbitrage Bot - HFT-optimized trading bot for crypto binary options arbitrage.

### Key Architecture Decisions
- Lock-free hot path using DashMap and atomics
- Zero-copy WebSocket parsing where possible
- Pre-hashed EIP-712 signing for shadow bids (<2ms)
- Fire-and-forget observability (<10ns overhead)
- Separate binaries: poly-collect (data), poly-import (historical), poly-bot (trading)

### External Dependencies
- polymarket-client-sdk: Official Polymarket Rust client (auth, discovery, orders)
- tokio-tungstenite: Custom WebSocket (minimal overhead for Binance)
- dashmap: Lock-free concurrent hash maps
- rust_decimal: Financial math (NEVER use f64 for prices)
- clickhouse: Data storage and replay

### Performance Targets
- WS message to state: <10us
- Arb detection: <1us
- Circuit breaker check: <10ns
- Shadow bid fire: <2ms
- Observability overhead: <10ns

## Codebase Patterns
[Agents add patterns they discover here]

## Priority
1. Phase 1 (poly-collect) is PRIORITY - start collecting data ASAP
2. Phases 2-9 can be developed in parallel while data collects
3. Every day of delay = less backtest data

## Completed Work

---

### [2026-01-12] Task p1-1: Workspace and shared crate setup
Files created:
- Cargo.toml (workspace root with all dependencies)
- crates/poly-common/Cargo.toml
- crates/poly-common/src/lib.rs
- crates/poly-common/src/types.rs

Verification:
- cargo check: PASSED
- cargo clippy -- -D warnings: PASSED
- cargo test: PASSED (5 tests)

Types implemented:
- CryptoAsset (BTC, ETH, SOL, XRP) with binance_symbol() helper
- Side (Buy, Sell) with opposite()
- Outcome (Yes, No) with opposite()
- OrderBookLevel (price, size) - all Decimal
- MarketWindow with window timing helpers
- SpotPrice for Binance trade data
- OrderBookSnapshot and OrderBookDelta for ClickHouse storage

Key decisions:
- Using rust_decimal v1.36 for all financial math
- clickhouse crate v0.13 with Row derive for type-safe inserts
- chrono with serde feature for timestamp handling
- All ClickHouse types derive Row for inserter compatibility

---

### [2026-01-12] Task p1-2: ClickHouse schema and client
Files created:
- crates/poly-common/src/schema.sql
- crates/poly-common/src/clickhouse.rs

Files modified:
- crates/poly-common/src/lib.rs (added clickhouse module export)

Verification:
- cargo clippy -- -D warnings: PASSED
- cargo test: PASSED (8 tests)

Schema tables defined:
- market_windows: ReplacingMergeTree for discovered markets
- spot_prices: MergeTree with 90-day TTL for Binance trades
- orderbook_snapshots: MergeTree with 90-day TTL for periodic captures
- orderbook_deltas: MergeTree with 90-day TTL for incremental updates
- price_history: MergeTree for historical import
- trade_history: ReplacingMergeTree for historical import
- decisions: MergeTree with 180-day TTL for observability

ClickHouseClient features:
- ClickHouseConfig with sensible defaults (max_rows: 10k, max_bytes: 10MB, period: 5s)
- ping() for connection testing
- create_tables() parses and executes schema.sql
- Type-safe inserters for each table type with auto-commit configuration
- Batch insert methods for one-off writes

Key decisions:
- Using Inserter from clickhouse::inserter module (not re-exported at crate root)
- Decimal(18, 8) for all price/quantity columns
- DateTime64(3, 'UTC') for millisecond precision timestamps
- LowCardinality(String) for repeated values (asset, side, action)
- 90-day TTL on operational data, 180-day on decisions

---

### [2026-01-12] Task p1-3: Market discovery for collector
Files created:
- crates/poly-collect/Cargo.toml
- crates/poly-collect/src/lib.rs
- crates/poly-collect/src/discovery.rs
- crates/poly-collect/src/main.rs

Files modified:
- Cargo.toml (added poly-collect to workspace members)

Verification:
- cargo clippy -- -D warnings: PASSED
- cargo test -p poly-collect: PASSED (4 tests)

MarketDiscovery features:
- Fetches active events from Gamma API (https://gamma-api.polymarket.com)
- Filters for 15-minute up/down markets by title keywords
- Detects crypto asset (BTC, ETH, SOL, XRP) from title
- Parses YES/NO token IDs from clobTokenIds JSON string
- Parses strike price from title (e.g., "$100,000")
- Stores discovered markets to ClickHouse market_windows table
- Runs discovery loop with configurable interval (default 5 min)
- Tracks known markets to avoid re-processing
- Graceful shutdown via broadcast channel

Key decisions:
- Using reqwest for HTTP instead of polymarket-client-sdk (simpler for read-only Gamma API)
- Gamma API returns clobTokenIds as JSON string, requires parsing
- 15-minute markets detected by title keywords (may need adjustment)
- Strike price parsing uses regex, defaults to Decimal::ZERO if not found
- Discovery interval set to 300s (5 minutes) in main.rs

Notes for next task (p1-4):
- Need tokio-tungstenite for Binance WebSocket
- Binance trade stream: wss://stream.binance.com:9443/ws/{symbol}@trade
- Buffer trades and batch write to spot_prices table

---

### [2026-01-12] Task p1-4: Binance WebSocket capture
Files created:
- crates/poly-collect/src/binance.rs

Files modified:
- crates/poly-collect/src/lib.rs (added binance module export)

Verification:
- cargo clippy -- -D warnings: PASSED
- cargo test -p poly-collect: PASSED (9 tests, 5 new)

BinanceCapture features:
- Connects to wss://stream.binance.com:9443/ws
- Subscribes to btcusdt@trade, ethusdt@trade, solusdt@trade, xrpusdt@trade
- Parses trade messages to SpotPrice (asset, price, quantity, timestamp)
- Buffers writes (default 500 records)
- Flushes to ClickHouse on buffer full or periodic interval (5s)
- Automatic reconnection with exponential backoff (1s initial, 60s max)
- Graceful shutdown via broadcast channel
- Handles ping/pong for connection keepalive
- Stats logging (trades received/written/errors)

Key decisions:
- Using combined stream subscription (single WS connection for all symbols)
- Decimal parsing from Binance string prices for exact math
- tokio::select! for concurrent message handling, flush timer, and shutdown
- Buffer cleared on successful flush, kept on error for retry
- Connection timeout of 10 seconds

Notes for next task (p1-5):
- Polymarket CLOB WebSocket at wss://clob.polymarket.com/ws
- Need to subscribe to token IDs from market discovery
- Handle book snapshots and deltas separately
- Periodic snapshot capture (100ms) for backtest fidelity

---

### [2026-01-12] Task p1-5: Polymarket CLOB WebSocket capture
Files created:
- crates/poly-collect/src/clob.rs

Files modified:
- crates/poly-collect/src/lib.rs (added clob module export)
- crates/poly-collect/Cargo.toml (added rust_decimal_macros dev dependency)

Verification:
- cargo clippy -- -D warnings: PASSED
- cargo test -p poly-collect: PASSED (19 tests, 10 new)

ClobCapture features:
- Connects to wss://ws-subscriptions-clob.polymarket.com/ws/market
- Subscribes to token IDs from shared ActiveMarkets state
- Handles "book" messages (full orderbook snapshots)
- Handles "price_change" messages (incremental deltas)
- Maintains in-memory OrderBookState per token with bid/ask HashMaps
- Periodic snapshot capture every 100ms for high-fidelity backtest data
- Buffers snapshots (500) and deltas (1000) for batch writes
- Automatic reconnection with exponential backoff (1s initial, 60s max)
- Sends PING every 9 seconds (Polymarket requires every 10s)
- Dynamically subscribes to new markets every 30 seconds
- Graceful shutdown via broadcast channel
- Stats logging (books received, snapshots/deltas captured/written)

OrderBookState features:
- apply_book() for full snapshot application
- apply_price_change() for delta updates (size=0 removes level)
- best_bid()/best_ask() for BBO extraction
- spread_bps() for spread calculation in basis points
- bid_depth()/ask_depth() for total liquidity
- to_snapshot() generates OrderBookSnapshot for ClickHouse

Key decisions:
- Using wss://ws-subscriptions-clob.polymarket.com/ws/market (official CLOB market endpoint)
- ActiveMarkets shared via Arc<RwLock<HashMap>> to coordinate with discovery
- Book messages parsed from JSON with bids/asks as OrderSummary arrays
- Price changes update both in-memory state AND record deltas for storage
- Snapshot interval of 100ms balances fidelity vs storage volume
- All prices use Decimal for exact financial math

Notes for next task (p1-6):
- Main binary needs to wire discovery, binance, and clob together
- ActiveMarkets shared between discovery (writer) and clob (reader)
- Need CLI args for --assets, --clickhouse-url
- Need TOML config file loading
- Graceful shutdown should stop all tasks

---
