# Progress Log - React Trading Dashboard

## Project Config
backend: rust (Cargo workspace)
frontend: bun (to be created in frontend/)
database: ClickHouse

## Source PRD
tasks/prd-react-dashboard.md

## Codebase Patterns

### Observability Pattern (CRITICAL - follow this for dashboard capture)
- See: crates/poly-bot/src/observability/capture.rs
- Bounded channel with try_send() - NEVER block hot path
- <10ns overhead requirement
- Fire-and-forget, drop on backpressure

### State Access Pattern
- See: crates/poly-bot/src/state.rs
- DashMap for concurrent access
- Atomics for flags/counters
- Lock-free reads on hot path

### ClickHouse Types
- See: crates/poly-bot/src/observability/types.rs
- Use Float64 for prices (clickhouse-rs doesn't support rust_decimal)
- Use clickhouse::Row derive

### Existing Tables
- decisions, counterfactuals, anomalies (observability)
- spot_prices, orderbook_snapshots, orderbook_deltas (market data)
- trade_history, price_history (historical imports)
- market_windows (window metadata)

## Key Files Reference
- Config: crates/poly-bot/src/config.rs
- Global State: crates/poly-bot/src/state.rs
- Observability Capture: crates/poly-bot/src/observability/capture.rs
- Schema: crates/poly-common/src/schema.sql

## Phases Overview
1. Backend Infrastructure: Schema + Capture channel + Session management
2. Backend Server: WebSocket + State serialization + REST API
3. Frontend Setup: Scaffold + Types + WebSocket + Store + Layout
4. Main Dashboard: Metrics + Equity + Markets + Circuit Breaker + Logs
5. Market Detail: Price chart + Order book + Position + Trades
6. Polish: Session metrics + Anomalies + Theme + Build + Integration test

## Completed Work

### [2026-01-15] Task: phase1-schema - Add new ClickHouse table schemas

Files changed:
- crates/poly-common/src/schema.sql

Changes:
- Added 5 new dashboard tables to schema.sql:
  - `sessions` - Tracks bot sessions with aggregates (ReplacingMergeTree)
  - `bot_trades` - All trades executed with full fill details (365 day TTL)
  - `pnl_snapshots` - Periodic P&L for equity curve visualization (180 day TTL)
  - `structured_logs` - Searchable logs with JSON fields (30 day TTL)
  - `market_sessions` - Per-market metrics within a session (ReplacingMergeTree)

Verification:
- All 5 CREATE TABLE statements present in schema.sql
- Follows existing patterns: Decimal(18,8) for money, LowCardinality for enums, proper TTLs

Learnings:
- Schema uses ReplacingMergeTree for sessions/market_sessions (updated via upsert pattern)
- MergeTree with TTL for time-series data (trades, pnl_snapshots, logs)
- UUID type available in ClickHouse for session_id, trade_id
- Nullable types for optional fields (end_time, settlement fields)

---
